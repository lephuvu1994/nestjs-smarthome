// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. ENUMS (Định nghĩa các loại dữ liệu cố định)
// ==========================================

enum UserRole {
  ADMIN
  USER
}

enum SharePermission {
  ADMIN    // Toàn quyền
  EDITOR   // Được điều khiển
  VIEWER   // Chỉ xem
}

enum DeviceProtocol {
  MQTT_WIFI
  ZIGBEE
  GSM_4G
  VIRTUAL
}

// Loại feature (nút bấm, cảm biến...)
enum FeatureType {
  BINARY    // Bật/Tắt (0/1)
  DIMMER    // Thanh trượt (0-100)
  SENSOR    // Chỉ đọc (Nhiệt độ, độ ẩm...)
  TEXT      // Dạng chữ
  COLOR     // Chỉnh màu (RGB/HEX)
  CAMERA    // Stream
}

enum DeviceFeatureCategory {
  light
  switch
  sensor
  camera
  lock
  curtain
  climate
}

// ==========================================
// 2. USER & AUTH (Người dùng & Phiên)
// ==========================================

model User {
  id               String    @id @default(uuid()) @db.Uuid
  firstname        String?
  lastname         String?
  email            String?   @unique
  phone            String?   @unique
  password         String
  role             UserRole  @default(USER)

  // OTP
  otpCode          String?   @map("otp_code")
  otpExpire        DateTime? @map("otp_expire")

  // Vị trí (Cache nhanh)
  last_latitude         Float?
  last_longitude        Float?
  last_altitude         Float?
  last_accuracy         Float?
  last_location_changed DateTime?

  // Quan hệ
  locations        Location[]
  owned_devices    Device[]      @relation("UserInventory")
  shared_devices   DeviceShare[] @relation("SharedToUser")
  owned_homes      Home[]        @relation("UserHomes")
  home_memberships HomeMember[]
  sessions         Session[]
  calendars        Calendar[]

  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@map("t_user")
}

model Session {
  id                 String   @id @default(uuid()) @db.Uuid
  hashedRefreshToken String   @unique
  deviceName         String?
  ipAddress          String?
  userAgent          String?
  expiresAt          DateTime

  userId             String   @db.Uuid
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@index([userId])
  @@map("t_session")
}

// ==========================================
// 3. CATALOG & PARTNER (Quản lý nguồn hàng & License)
// ==========================================

// Công ty / Đối tác
model Partner {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique // VD: "COMPANY_A"
  name        String
  isActive    Boolean  @default(true)

  quotas      LicenseQuota[]
  hardwares   HardwareRegistry[]
  devices     Device[]

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("t_partner")
}

// Khuôn mẫu thiết bị (Blueprint)
model DeviceModel {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique // VD: "WIFI_SWITCH_4"
  name        String   // VD: "Công tắc WiFi 4 nút"
  description String?

  // [BLUEPRINT] JSON quy định tính năng
  // VD: [{ "code": "sw1", "type": "BINARY", "name": "Nút 1" }]
  featuresConfig Json    @default("[]") @db.JsonB

  quotas      LicenseQuota[]
  hardwares   HardwareRegistry[]
  devices     Device[] // Quan hệ với các thiết bị thực tế đang chạy

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("t_device_model")
}

// Quản lý số lượng License
model LicenseQuota {
  id              String   @id @default(uuid()) @db.Uuid

  partner_id       String   @db.Uuid
  partner         Partner  @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  device_model_id   String   @db.Uuid
  deviceModel     DeviceModel @relation(fields: [device_model_id], references: [id], onDelete: Cascade)

  maxQuantity     Int      @default(0)
  activatedCount  Int      @default(0)
  isActive        Boolean  @default(true)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@unique([partner_id, device_model_id])
  @@map("t_license_quota")
}

// Sổ cái phần cứng (Chip vật lý)
model HardwareRegistry {
  id            String   @id @default(uuid()) @db.Uuid

  // Định danh vật lý gốc (MAC Address / IMEI)
  identifier          String   @unique

  // Credentials kết nối MQTT (Cấp cho Chip)
  deviceToken   String   @unique
  mqttUsername  String?
  mqttPassword  String?
  mqttBroker    String?

  // Thông tin quản lý
  partner_id     String   @db.Uuid
  partner       Partner  @relation(fields: [partner_id], references: [id])

  device_model_id String   @db.Uuid
  deviceModel   DeviceModel @relation(fields: [device_model_id], references: [id])

  // Link tới Device Logic (1-1): Khi User add vào App thì field này sẽ có dữ liệu
  device        Device?

  firmwareVer   String?
  ipAddress     String?
  isBanned      Boolean  @default(false)
  activatedAt   DateTime @default(now())

  @@map("t_hardware_registry")
}

// ==========================================
// 4. DEVICE INSTANCE (Thiết bị của User)
// ==========================================

model Device {
  id           String   @id @default(uuid()) @db.Uuid

  // Tên hiển thị trong App (User có thể đổi)
  name         String

  // 1. ĐỊNH DANH LOGIC (Dùng để giao tiếp API/MQTT Topic)
  token        String         @unique @default(uuid())

  // 2. ĐỊNH DANH VẬT LÝ & GIAO THỨC
  identifier   String         // Copy từ HardwareRegistry sang hoặc tự nhập (nếu là Virtual)
  protocol     DeviceProtocol @default(MQTT_WIFI)

  // 3. LIÊN KẾT MODEL (Để biết nó là loại gì)
  device_model_id String      @db.Uuid
  deviceModel     DeviceModel @relation(fields: [device_model_id], references: [id])

  // --- [NEW] LIÊN KẾT ĐỐI TÁC (Multi-tenancy) ---
  // Thiết bị này thuộc quyền quản lý/phân phối của công ty nào?
  partner_id   String   @db.Uuid
  partner      Partner  @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  // 4. LIÊN KẾT PHẦN CỨNG (Nếu là thiết bị thật)
  hardware_id  String?        @unique @db.Uuid
  hardware     HardwareRegistry? @relation(fields: [hardware_id], references: [id])

  // Sở hữu
  owner_id     String   @db.Uuid
  owner        User     @relation("UserInventory", fields: [owner_id], references: [id])
  shared_users DeviceShare[]

  // Vị trí
  home_id      String?  @db.Uuid
  home         Home?    @relation(fields: [home_id], references: [id], onDelete: SetNull)
  room_id      String?  @db.Uuid
  room         Room?    @relation(fields: [room_id], references: [id], onDelete: SetNull)

  // Kỹ thuật
  service_id   String?  @db.Uuid // Gladys service ID (Optional)
  service      Service? @relation(fields: [service_id], references: [id])

  // Dữ liệu runtime
  features     DeviceFeature[]
  params       DeviceParam[]

  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Ràng buộc duy nhất: Một ID chỉ tồn tại duy nhất trong 1 protocol
  @@unique([identifier, protocol])
  @@index([identifier])
  @@index([partner_id])
  @@map("t_device")
}

model DeviceFeature {
  id          String   @id @default(uuid()) @db.Uuid

  // Mã code tính năng (VD: switch_1). Map từ JSON Config của Model
  code        String
  name        String   // Tên hiển thị (VD: Đèn trần)

  // Metadata
  category    DeviceFeatureCategory
  type        FeatureType // BINARY, DIMMER...

  min         Float?
  max         Float?
  unit        String?
  read_only   Boolean  @default(false)

  // Giá trị hiện tại (Runtime Value)
  last_value  Float?   // Dùng cho dạng số
  last_value_string String? // Dùng cho dạng text/color

  // Quan hệ
  device_id   String   @db.Uuid
  device      Device   @relation(fields: [device_id], references: [id], onDelete: Cascade)

  // Lịch sử trạng thái
  states      DeviceFeatureState[]

  // Mỗi thiết bị chỉ có 1 feature code duy nhất (VD: Device A chỉ có 1 nút 'switch_1')
  @@unique([device_id, code])
  @@map("t_device_feature")
}

model DeviceFeatureState {
  id         String   @id @default(uuid()) @db.Uuid
  value      Float?
  value_text String?

  feature_id String   @db.Uuid
  feature    DeviceFeature @relation(fields: [feature_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())

  @@index([feature_id, created_at(sort: Desc)])
  @@map("t_device_feature_state")
}

model DeviceParam {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  value     String
  device_id String   @db.Uuid
  device    Device   @relation(fields: [device_id], references: [id], onDelete: Cascade)

  @@map("t_device_param")
}

model DeviceShare {
  id          String          @id @default(uuid()) @db.Uuid
  device_id   String          @db.Uuid
  device      Device          @relation(fields: [device_id], references: [id], onDelete: Cascade)
  user_id     String          @db.Uuid
  user        User            @relation("SharedToUser", fields: [user_id], references: [id], onDelete: Cascade)
  permission  SharePermission @default(EDITOR)
  created_at  DateTime        @default(now())

  @@unique([device_id, user_id])
  @@map("t_device_share")
}

// ==========================================
// 5. HOME & ROOM (Nhà & Phòng)
// ==========================================

model Home {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  latitude  Float?
  longitude Float?
  radius    Int      @default(100)

  owner_id  String   @db.Uuid
  owner     User     @relation("UserHomes", fields: [owner_id], references: [id], onDelete: Cascade)

  members   HomeMember[]
  rooms     Room[]
  devices   Device[]
  scenes    Scene[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("t_home")
}

model HomeMember {
  id        String   @id @default(uuid()) @db.Uuid
  user_id   String   @db.Uuid
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  home_id   String   @db.Uuid
  home      Home     @relation(fields: [home_id], references: [id], onDelete: Cascade)
  role      String   @default("MEMBER")

  @@unique([user_id, home_id])
  @@map("t_home_member")
}

model Room {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  home_id   String   @db.Uuid
  home      Home     @relation(fields: [home_id], references: [id], onDelete: Cascade)
  devices   Device[]
  created_at DateTime @default(now())

  @@map("t_room")
}

// ==========================================
// 6. MISC (Scene, Location, System...)
// ==========================================

model Service {
  id      String   @id @default(uuid()) @db.Uuid
  name    String   @unique
  status  String?
  devices Device[]
  @@map("t_service")
}

model Scene {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  active      Boolean  @default(true)
  triggers    Json     @default("[]")
  actions     Json     @default("[]")
  home_id     String   @db.Uuid
  home        Home     @relation(fields: [home_id], references: [id], onDelete: Cascade)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("t_scene")
}

model Location {
  id        String   @id @default(uuid()) @db.Uuid
  latitude  Float
  longitude Float
  accuracy  Float?
  battery   Int?
  user_id   String   @db.Uuid
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())

  @@index([user_id, created_at(sort: Desc)])
  @@map("t_location")
}

model Calendar {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  user_id     String   @db.Uuid
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  events      CalendarEvent[]
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  @@map("t_calendar")
}

model CalendarEvent {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  start       DateTime
  end         DateTime
  all_day     Boolean  @default(false)
  calendar_id String   @db.Uuid
  calendar    Calendar @relation(fields: [calendar_id], references: [id], onDelete: Cascade)
  @@index([start, end])
  @@map("t_calendar_event")
}

model SystemConfig {
  key         String @id
  value       String
  description String?
  @@map("t_system_config")
}
